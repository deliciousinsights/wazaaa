<!DOCTYPE html><html lang="en"><head><title>models/User</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="models/User"><meta name="groc-project-path" content="src/models/User.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/models/User.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="modle-pour-les-utilisateurs">Modèle pour les utilisateurs</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> mongoose, { Schema } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="le-schma-qui-va-bien">Le schéma qui va bien</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Voir la doc de <a href="entry.html">Entry</a> pour plus de détails.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> Schema({
  _id: { type: <span class="hljs-built_in">String</span>, required: <span class="hljs-literal">true</span> },
  name: <span class="hljs-built_in">String</span>,
  provider: { type: <span class="hljs-built_in">String</span>, required: <span class="hljs-literal">true</span> },
  joinedAt: { type: <span class="hljs-built_in">Date</span>, <span class="hljs-keyword">default</span>: <span class="hljs-built_in">Date</span>.now },
})</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="mthodes-statiques">Méthodes statiques</h2>
<p>Chaque modèle produit par Mongoose sur base de ce schéma disposera de ces méthodes statiques.
Il s&#39;agit ici de faciliter la recherche ou la création à la volée d&#39;un <code>User</code> par Passport
lorsqu&#39;un fournisseur d&#39;authentification lui renvoie une identité confirmée.</p>
<p>La capacité <a href="http://docs.mongodb.org/manual/reference/method/db.collection.update/#upsert-parameter"><code>upsert</code></a>
de <code>update</code> est ici fort utile.</p>
<p>On renvoie non pas le résultat natif (auquel cas fournir <code>done</code> en dernier argument de <code>update</code> aurait suffi),
mais l&#39;id du modèle (qu&#39;on connaît déjà à la base, pratique).  C&#39;est ce résultat qui sera, <em>in fine</em>,
passé à la sérialisation dans la session par Passport (voir le contrôleur <code>users</code> pour le code).</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">Object</span>.assign(userSchema.statics, {
  findOrCreateByAuth(id, name, provider, done) {
    <span class="hljs-keyword">this</span>.update(</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Recherche</p></div></div><div class="code"><div class="wrapper">      { _id: id, provider },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Mise à jour (l&#39;id est supposé être celui de la recherche)</p></div></div><div class="code"><div class="wrapper">      { $set: { name }, $setOnInsert: { joinedAt: <span class="hljs-built_in">Date</span>.now() } },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Activation du mode upsert (insertion si non trouvé)</p></div></div><div class="code"><div class="wrapper">      { upsert: <span class="hljs-literal">true</span> },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Forwarder l&#39;erreur éventuelle, mais à défaut transmettre l&#39;id comme valeur résultante.</p></div></div><div class="code"><div class="wrapper">      (err) =&gt; done(err, id)
    )
  },
})</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Nos modules de modèle renvoient toujours un modèle Mongoose, basé sur notre schéma.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> Model = mongoose.model(<span class="hljs-string">'User'</span>, userSchema)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Model</div></div></div></div></body></html>